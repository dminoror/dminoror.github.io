<!DOCTYPE html>
<html>

<head>
  <title>GPlayer Playlists</title>
  <meta charset="utf-8" />
  <script src="jquery-3.5.1.js"></script>
  <style type='text/css'>
    body,
    div {
      margin: 0;
      border: 0 none;
      padding: 0;
    }

    html,
    body,
    #wrapper {
      height: 100%;
      min-height: 100%;
    }

    #mainPanel {
      height: 160px;
      min-height: 160px;
      background-color: white;
      border-bottom: 5px solid gray;
      align-content: center;
    }

    #left,
    #right {
      height: calc(97vh - 160px);
      min-height: calc(97vh - 160px);
    }

    #wrapper {
      margin: 0 auto;
      overflow: hidden;
      width: 960px;
    }

    #left {
      background: white;
      float: left;
      width: 75%;
      display: flex;
      border-right: 4px solid gray;
    }

    #right {
      background: white;
      margin-left: 75%;
      margin-top: -16px;
    }

    .itemsList {
      overflow: auto;
      display: block;
      width: 100%;
      padding: 0;
      margin: 0;
    }

    .playitem {
      color: purple;
      list-style-type: decimal;
      border-bottom: 1px solid black;
    }

    #progress {
      width: 80%;
    }

    #playerPanel {
      display: grid;
      grid-template-columns: 200px auto 200px;
    }

    .playerButton {
      display: inline-block;
      height: 40px;
      width: 10%;
    }
  </style>
</head>

<body>
  <dev id='wapper'>
    <div id='mainPanel'>
      <button id="authorize_button" style="display: none;">Authorize</button>
      <button id="signout_button" style="display: none;">Sign Out</button>
      <p style="text-align: center;">
        <label id="currentTimeLabel">00:00</label>
        <input type="range" min="0" max="100" value="0" class="slider" id="progress">
        <label id="durationLabel">00:00</label>
      </p>
      <div id="playerPanel">
        <div style="height: 80px; text-align: center;">
          <div style="margin-top: 11px;">
            <button style="height: 24px; width: 100px;" id="randomButton">No Random</button>
          </div>
          <div style="margin-top: 7px;">
            <button style="height: 24px; width: 100px;" id="loopButton">Loop</button>
          </div>
        </div>
        <ul style="text-align: center;">
          <button class="playerButton" id="prevButton">|﹤</button>
          <button class="playerButton" id="playButton">load</button>
          <button class="playerButton" id="nextButton">﹥|</button>
        </ul>
        <div style="display: flex; flex-direction: row; align-items: center;">
          <span>Volume</span>
          <input style="flex: 1; width: 100px;" type="range" min="0" max="100" value="100" id="volumeInputer"/>
          <span style="margin-right: 40px; width: 30px; text-align: center;" id="volumeLabel">100</span>
        </div>
      </div>

    </div>
    <div id="left">
      <ul id="currentSongList" class="itemsList">
      </ul>
    </div>
    <div id="right">
      <ul id="playlistsList" class="itemList">
      </ul>
    </div>


  </dev>



  <pre id="content" style="white-space: pre-wrap;"></pre>

  <script type="text/javascript">

    // Client ID and API key from the Developer Console
    var CLIENT_ID = '423335313231-giakunp57g1k5mavo5geh2uosq19p7n6.apps.googleusercontent.com';
    var API_KEY = 'AIzaSyBAaSYAjPtehAICYMErbTdmQifmxJaLkx0';

    // Array of API discovery doc URLs for APIs used by the quickstart
    var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    var SCOPES = 'https://www.googleapis.com/auth/drive.metadata.readonly';

    var authorizeButton = document.getElementById('authorize_button');
    var signoutButton = document.getElementById('signout_button');
    var playButton = document.getElementById('playButton');
    var prevButton = document.getElementById('prevButton')
    var nextButton = document.getElementById('nextButton')
    var progress = document.getElementById('progress');
    var volumeInputer = document.getElementById('volumeInputer')
    var volumeLabel = document.getElementById('volumeLabel')
    var currentTimeLabel = document.getElementById('currentTimeLabel');
    var durationLabel = document.getElementById('durationLabel');
    var currentSongList = document.getElementById('currentSongList');
    var playlistsList = document.getElementById('playlistsList')
    var randomButton = document.getElementById('randomButton')
    var loopButton = document.getElementById('loopButton')

    var audioContext = new AudioContext()
    audioContext.close()
    var source
    var volumeGain
    var isPlaying = false
    var startTime = audioContext.currentTime
    var playlists
    var playitemIndex = -1
    var currentPlaylist
    var displayPlaylist
    var displayPlaylistIndex
    var randomMode = false
    var loopMode = 0 // 0:Loop 1:SingleLoop 2:NoLoop
    var randomIndexArray
    var displayPlayitemIndex

    var preloadFileId
    var preloadRequest
    var preloadResponse


    /**
     *  On load, called to load the auth2 library and API client library.
     */
    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    /**
     *  Initializes the API client library and sets up sign-in state
     *  listeners.
     */
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function () {
        // Listen for sign-in state changes.
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        //return
        // Handle the initial sign-in state.
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;
        playButton.onclick = handlePlayClick;
        prevButton.onclick = handlePrevClick;
        nextButton.onclick = handleNextClick;
      }, function (error) {
        appendPre(JSON.stringify(error, null, 2));
      });
    }

    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'block';
        //appendPre(gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().id_token);
        if (gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().id_token.length > 0) {
          console.log("got accessToken "/* + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().id_token*/);
        }
        loadPlaylists(function (response, error) {
          //console.log(response);
          if (error != null) {
            console.log('playlists load file, ' + error);
          }
          else {
            //console.log('response = ' + response);
            var json = JSON.parse(response)
            playlists = json
            refreshLists()
          }
        });

      } else {
        authorizeButton.style.display = 'block';
        signoutButton.style.display = 'none';
      }
    }

    function refreshLists() {
      $(playlistsList).empty()
      for (let i = 0; i < playlists.length; i++) {
        let playlist = playlists[i];
        let li = document.createElement("li")
        li.className = 'playitem'
        li.appendChild(document.createTextNode(playlist.name))
        playlistsList.appendChild(li)
        li.onclick = function () {
          playlistListClick(i)
        }
        li.onmouseover = function () {
          li.style.backgroundColor = 'yellow'
        }
        li.onmouseout = function () {
          li.style.backgroundColor = 'white'
        }
      }
      displayPlaylistIndex = 0
      displayPlaylist = playlists[displayPlaylistIndex]
      refreshPlaylist()
    }

    function refreshPlaylist() {
      $(currentSongList).empty()
      let playlist = displayPlaylist
      for (let j = 0; j < playlist.list.length; j++) {
        var playitem = playlist.list[j]
        let li = document.createElement("li")
        li.className = 'playitem'
        var pathArray = playitem.path.split("\\")
        var fileName = pathArray[pathArray.length - 1]
        li.appendChild(document.createTextNode(fileName))
        currentSongList.appendChild(li);
        if (displayPlaylist === currentPlaylist && j == displayPlayitemIndex) {
          li.style.backgroundColor = 'orange'
        }
        li.onclick = function () {
          currentSongClick(j)
        }
        li.onmouseover = function () {
          if (j != displayPlayitemIndex) {
            li.style.backgroundColor = 'yellow'
          }
        }
        li.onmouseout = function () {
          if (j != displayPlayitemIndex) {
            li.style.backgroundColor = 'white'
          }
        }
      }
    }

    function playlistListClick(index) {
      console.log("playlist index " + index + "clicked")
      displayPlaylistIndex = index
      displayPlaylist = playlists[index]
      refreshPlaylist()
    }

    randomButton.addEventListener('click', function(event) {
      randomMode = !randomMode
      if (randomMode) {
        randomButton.textContent = 'Random'
      }
      else {
        randomButton.textContent = 'No Random'
        playitemIndex = displayPlayitemIndex
      }
    })
    loopButton.addEventListener('click', function(event) {
      if (loopMode == 0) {
        loopMode = 1
        loopButton.textContent = 'Single Loop'
      }
      else if (loopMode == 1) {
        loopMode = 2
        loopButton.textContent = 'No Loop'
      }
      else { 
        loopMode = 0
        loopButton.textContent = 'Loop'
      }
    })

    function currentSongClick(index) {
      console.log("playitem index " + index + "clicked")
      if (playitemIndex < currentSongList.children.length && playitemIndex >= 0) {
        currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'white'
      }
      currentPlaylist = displayPlaylist
      randomIndexArray = shuffleIndexArray(currentPlaylist.list.length)
      playitemIndex = index
      let playitem = currentPlaylist.list[playitemIndex]
      displayPlayitemIndex = playitemIndex
      currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'orange'
      loadMusic(playitem.gdID)
    }

    progress.addEventListener('change', function (event) {
      console.log('seek to ' + progress.value);
      seek(progress.value);
    })
    volumeInputer.addEventListener('change', function (event) {
      volumeLabel.textContent = volumeInputer.value
      volumeGain.gain.value = volumeInputer.value / 100.0
    })
    var isSliding = false;
    progress.addEventListener('mousedown', function (event) {
      //console.log('seek down');
      isSliding = true;
    });
    progress.addEventListener('mouseup', function (event) {
      //console.log('seek up');
      isSliding = false;
    });

    var progressTimer = setInterval(function () {
      if (!isSliding && isPlaying) {
        let currentTime = getCurrentTime();
        progress.value = currentTime;
        currentTimeLabel.textContent = formatedTime(currentTime);
      }
    }, 500);

    function handlePlayClick(event) {
      if (audioContext.state == 'suspended') {
        console.log('audioContext suspended, try resume');
        audioContext.resume();
        playButton.textContent = 'pause';
        isPlaying = true;
      }
      else if (audioContext.state == 'running') {
        console.log('audioContext running, try pause');
        audioContext.suspend();
        playButton.textContent = 'play';
        isPlaying = false;
      }
      else if (audioContext.state == 'closed') {
        currentPlaylist = displayPlaylist
        randomIndexArray = shuffleIndexArray(currentPlaylist.list.length)
        if (currentPlaylist.length == 0) {
          console.log('current playlist no music')
          return
        }
        if (playitemIndex >= currentPlaylist.list.length || playitemIndex < 0) {
          playitemIndex = 0
        }
        console.log('audioContext closed, try load');
        let playitem = getPlayitem(playitemIndex)
        console.log('displayPlayitemIndex = ' + displayPlayitemIndex)
        currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'orange'
        loadMusic(playitem.gdID)
      }
    }
    function handlePrevClick(event) {
      prev()
    }
    function handleNextClick(event) {
      next(true)
    }

    function seek(time) {
      source.onended = null;
      source.stop();
      setupAudioSource(source.buffer, time)
      startTime = audioContext.currentTime - time;
    }

    function prev() {
      console.log('prev')
      if (displayPlaylist === currentPlaylist) {
        currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'white'
      }
      playitemIndex -= 1
      if (playitemIndex < 0) {
        playitemIndex = currentPlaylist.list.length - 1
      }
      let playitem = getPlayitem(playitemIndex)
      if (displayPlaylist === currentPlaylist) {
        currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'orange'
      }
      loadMusic(playitem.gdID)
    }
    function next(forceNext) {
      console.log('next')
      if (displayPlaylist === currentPlaylist) {
        currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'white'
      }
      playitemIndex = getNextPlayitemIndex()
      if (playitemIndex == 0) {
        if (!forceNext && loopMode == 2) {
          console.log('No loop reach end')
          playButton.textContent = 'play'
          return
        }
        if (randomMode) {
          shuffleIndexArray(currentPlaylist.list.length)
        }
      }
      let playitem = getPlayitem(playitemIndex)
      if (displayPlaylist === currentPlaylist) {
        currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'orange'
      }
      loadMusic(playitem.gdID)
    }

    function getCurrentTime() {
      return audioContext.currentTime - startTime;
    }
    function formatedTime(time) {
      let hours = Math.floor(time / 3600);
      let minutes = Math.floor((time - (hours * 3600)) / 60);
      let seconds = Math.floor(time - (hours * 3600) - (minutes * 60));

      if (hours == 0) {
        hours = "";
      }
      else if (hours < 10) {
        hours = "0" + hours + ":";
      }
      if (minutes < 10) { minutes = "0" + minutes; }
      if (seconds < 10) { seconds = "0" + seconds; }
      return hours + minutes + ':' + seconds;
    }

    function handSourceEnded(event) {
      console.log('source ended');
      if (loopMode == 1) {
        console.log('single loop, seek to 0')
        seek(0)
      }
      else {
        audioContext.close();
        isPlaying = false;
        next(false)
      }
    }
    function getNextPlayitemIndex() {
      let newIndex = playitemIndex + 1
      if (newIndex >= currentPlaylist.list.length) {
        newIndex = 0
      }
      return newIndex
    }
    function getPlayitem(index) {
      if (randomMode) {
        index = randomIndexArray[index]
      }
      displayPlayitemIndex = index
      return currentPlaylist.list[index]
    }
    function getPreloadPlayitem() {
      let index = getNextPlayitemIndex()
      if (randomMode) {
        index = randomIndexArray[index]
      }
      return currentPlaylist.list[index]
    }

    function handleAudioData(response) {
      let playAudio = function (buffer) {
        console.log('audio duration = ' + buffer.duration);
        setupAudioSource(buffer, 0)
        startTime = audioContext.currentTime;
        isPlaying = true;
        progress.max = buffer.duration;
        durationLabel.textContent = formatedTime(buffer.duration);
        console.log('playAudio load succeseed');
        playButton.textContent = 'pause';
        startPreload()
      }
      let handleError = function (error) {
        console.log("audio handleError");
        audioContext.close();
        isPlaying = false;
        console.log('playAudio load failed');
        playButton.textContent = 'load';
        next(false)
      }
      audioContext.decodeAudioData(response, playAudio, handleError);
    }

    function setupAudioSource(buffer, startTime) {
      let newSource = audioContext.createBufferSource()
      newSource.buffer = buffer;
      let gain = audioContext.createGain()
      gain.gain.value = volumeInputer.value / 100.0
      newSource.connect(gain)
      gain.connect(audioContext.destination)
      newSource.start(0, startTime);
      newSource.onended = handSourceEnded
      source = newSource
      volumeGain = gain
    }

    function loadMusic(fileId) {
      isPlaying = false;
      if (audioContext.state != 'closed') {
        audioContext.close();
      }
      audioContext = new AudioContext();

      //console.log('preloadResponse = ' + preloadResponse + ' preloadFileId = ' + preloadFileId + ' fileId = ' + fileId)
      if (preloadResponse != null && preloadFileId == fileId) {
        console.log('preload found')
        handleAudioData(preloadResponse)
        preloadResponse = null
        preloadFileId = null
        return
      }
      console.log('preload not found, start fetch')
      if (preloadRequest != null) {
        preloadRequest.abort()
      }
      preloadRequest = null
      preloadResponse = null
      preloadFileId = null
      let accessToken = gapi.auth.getToken().access_token;
      let xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://www.googleapis.com/drive/v3/files/' + fileId + '?alt=media');
      xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
      xhr.responseType = 'arraybuffer';
      xhr.onload = function () {
        console.log("request onload");
        handleAudioData(xhr.response)
      };
      xhr.onerror = function () {
        console.log("request onerror");
        isPlaying = false;
        next(false)
      };
      xhr.send();
    }

    function startPreload() {
      let nextPlayitem = getPreloadPlayitem()
      preloadMusic(nextPlayitem.gdID)
    }

    function preloadMusic(fileId) {
      console.log('preload ' + fileId)
      var accessToken = gapi.auth.getToken().access_token;
      preloadFileId = fileId
      preloadRequest = new XMLHttpRequest();
      preloadRequest.open('GET', 'https://www.googleapis.com/drive/v3/files/' + fileId + '?alt=media');
      preloadRequest.setRequestHeader('Authorization', 'Bearer ' + accessToken);
      preloadRequest.responseType = 'arraybuffer';
      preloadRequest.onload = function () {
        console.log("preload onload");
        preloadResponse = preloadRequest.response
        preloadRequest = null
      };
      preloadRequest.onerror = function () {
        console.log("preload onerror");
        preloadRequest = null
      };
      preloadRequest.send();
    }

    function loadPlaylists(callback) {
      console.log('start loadPlaylists')
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://www.googleapis.com/drive/v3/files/1LiZwOqFiQgPWMKzTYwauZZShLGTcwsUv?alt=media');
      //xhr.responseType = 'json';
      var accessToken = gapi.auth.getToken().access_token;
      xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
      xhr.onload = function () {
        var status = xhr.status;
        if (status === 200) {
          callback(xhr.response, null);
        }
        else {
          callback(xhr.response, new Error('http error'));
        }
      };
      xhr.onerror = function () {
        callback(null, new Error('request failed'));
      };
      xhr.send();
    }

    function getURL(url, callback) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.responseType = 'json';
      xhr.onload = function () {
        var status = xhr.status;
        if (status === 200) {
          callback(xhr.response, null);
        }
        else {
          callback(xhr.response, new Error('http error'));
        }
      };
      xhr.onerror = function () {
        callback(null, new Error('request failed'));
      };
      xhr.send();
    }

    function shuffleIndexArray(length) {
      let array = new Array(length)
      for (let i = 0; i < length; i++) {
        array[i] = i
      }
      for (let i = array.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array
    }


    /**
     * Download a file's content.
     *
     * @param {File} file Drive File instance.
     * @param {Function} callback Function to call when the request is complete.
     */
    function downloadFile() {
      var accessToken = gapi.auth.getToken().access_token;
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://www.googleapis.com/drive/v3/files/1NBjYH3rxfL7Hf7B0OAjCYn8oxLSx8Mzy?alt=media');
      xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
      //xhr.responseType = 'blob';
      xhr.responseType = 'arraybuffer';

      //var audioContext = new AudioContext();
      //var source = audioContext.createBufferSource();

      xhr.onload = function () {
        console.log("request onload");
        console.log(xhr.response);

        var playAudio = function (buffer) {
          if (source.buffer == null) {
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start(0);
          }
        }
        var handleError = function (error) {
          console.log("audio handleError");
        }

        audioContext.decodeAudioData(xhr.response, playAudio, handleError);

        //var blob = xhr.response;
        //saveFile(blob);
      };
      xhr.onerror = function () {
        console.log("request onerror");
      };
      xhr.send();
    }
    function saveFile(blob) {
      var fileName = 'Test.m4a'
      var tempEl = document.createElement("a");
      document.body.appendChild(tempEl);
      tempEl.style = "display: none";
      url = window.URL.createObjectURL(blob);
      tempEl.href = url;
      tempEl.download = fileName;
      tempEl.click();
      window.URL.revokeObjectURL(url);
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick(event) {
      gapi.auth2.getAuthInstance().signIn();
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick(event) {
      gapi.auth2.getAuthInstance().signOut();
    }

    /**
     * Append a pre element to the body containing the given message
     * as its text node. Used to display the results of the API call.
     *
     * @param {string} message Text to be placed in pre element.
     */
    function appendPre(message) {
      var pre = document.getElementById('content');
      var textContent = document.createTextNode(message + '\n');
      pre.appendChild(textContent);
    }

    /**
     * Print files.
     */
    function listFiles() {
      gapi.client.drive.files.list({
        'pageSize': 10,
        'fields': "nextPageToken, files(id, name)"
      }).then(function (response) {
        appendPre('Files:');
        var files = response.result.files;
        if (files && files.length > 0) {
          for (var i = 0; i < files.length; i++) {
            var file = files[i];
            appendPre(file.name + ' (' + file.id + ')');
          }
        } else {
          appendPre('No files found.');
        }
      });
    }

  </script>

  <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
    onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
</body>

</html>