<!DOCTYPE html>
<html>

<head>
  <title>GPlayer Playlists</title>
  <meta charset="utf-8" />
  <script src="jquery-3.5.1.js"></script>
  <style type='text/css'>
    body,
    div {
      margin: 0;
      border: 0 none;
      padding: 0;
    }

    html,
    body,
    #wrapper {
      height: 100%;
      min-height: 100%;
    }

    #mainPanel {
      height: 160px;
      min-height: 160px;
      background-color: white;
      border-bottom: 5px solid gray;
      align-content: center;
    }

    #left,
    #right {
      height: calc(100vh - 165px);
      min-height: calc(100vh - 165px);
    }

    #wrapper {
      margin: 0 auto;
      overflow: hidden;
      width: 960px;
    }

    #bottomPanel {
      width: 100%;
      height: 50vh;
      min-height: 50vh;
      float: left;
    }

    #left {
      background: white;
      width: 75%;
      border-right: 4px solid gray;
      float: left;
    }

    #right {
      background: transparent;
      margin-left: calc(75% + 12px);
      width: calc(20% - 12px);
      float: left;
      position: fixed;
    }

    .listContainer {
      height: calc(100vh - 165px - 40px);
      min-height: calc(100vh - 165px - 40px);
      display: flex;
      width: 100%;
    }

    .itemsList {
      overflow: auto;
      display: block;
      width: 100%;
      padding: 0;
      margin: 0;
    }

    .playitem {
      color: purple;
      list-style-type: decimal;
      height: 24px;
      border-bottom: 1px solid black;
      min-width: 0px;
    }

    #progress {
      width: 80%;
    }

    #playerPanel {
      display: grid;
      grid-template-columns: 200px auto 200px;
    }

    .playerButton {
      display: inline-block;
      text-align: center;
      height: 40px;
      width: 12%;
    }

    #rightMenu {
      position: fixed;
      left: 100px;
      top: 100px;
      width: 100px;
      background-color: white;
    }
  </style>
</head>

<body>
  <dev id='wapper'>
    <div id='mainPanel'>
      <div id='userPanel'>
        <button id="authorize_button" style="display: none; float: left; width: 80px;">Authorize</button>
        <button id="signout_button" style="display: none;float: left; width: 80px;">Sign Out</button>
        <div style="text-align: center; margin-right: 80px;">
          <label id="infoLabel">說明</label>
        </div>
      </div>
      <p style="text-align: center;">
        <label id="currentTimeLabel">00:00</label>
        <input type="range" min="0" max="100" value="0" class="slider" id="progress">
        <label id="durationLabel">00:00</label>
      </p>
      <div id="playerPanel">
        <div style="height: 80px; text-align: center;">
          <div style="margin-top: 11px;">
            <button style="height: 24px; width: 100px;" id="randomButton">Random</button>
          </div>
          <div style="margin-top: 7px;">
            <button style="height: 24px; width: 100px;" id="loopButton">Loop</button>
          </div>
        </div>
        <ul style="text-align: center;">
          <button class="playerButton" id="prevButton">|﹤</button>
          <button class="playerButton" id="playButton">load</button>
          <button class="playerButton" id="nextButton">﹥|</button>
        </ul>
        <div style="display: flex; flex-direction: row; align-items: center;">
          <span>Volume</span>
          <input style="flex: 1; width: 100px;" type="range" min="0" max="100" value="100" id="volumeInputer" />
          <span style="margin-right: 40px; width: 30px; text-align: center;" id="volumeLabel">100</span>
        </div>
      </div>

    </div>
    <div id="bottomPanel">
      <div id="left">
        <div class="listContainer">
          <ul id="currentSongList" class="itemsList">
          </ul>
        </div>
        <div style="text-align: center; height: 40px; align-items: center; display: flex; flex-direction: column; ">
          <button style="text-align: center; height: 32px; display: block; margin-top: 4px;" id="addPlayitemButton">add
            file to this playlist</button>
        </div>
      </div>
      <div id="right">
        <div class="listContainer">
          <ul id="playlistsList" class="itemsList">
          </ul>
        </div>
        <div style="text-align: center; height: 40px; align-items: center; display: flex; flex-direction: row; ">
          <button style="text-align: center; height: 32px; display: block; margin-top: 4px; float: right;"
            id="addPlaylistButton">new playlist</button>
        </div>
      </div>
    </div>

    <div style="position: fixed; bottom: 0px; right: 0px; width: 5%; background-color: blue;">
      <button style="float: right; vertical-align: bottom;" id="saveConfigButton">Save as...</button>
      <button style="float: right; vertical-align: bottom;" id="loadConfigButton">Load Config</button>
    </div>

    <div id="rightMenu" hidden="true"
      style="border-color: black; border-width: 1px; border-style: solid; border-radius: 5px;">
    </div>

  </dev>




  <pre id="content" style="white-space: pre-wrap;"></pre>

  <script type="text/javascript">

    // Client ID and API key from the Developer Console
    var CLIENT_ID = '423335313231-giakunp57g1k5mavo5geh2uosq19p7n6.apps.googleusercontent.com';

    // Array of API discovery doc URLs for APIs used by the quickstart
    var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    //var SCOPES = ['https://www.googleapis.com/auth/drive.file'];
    var SCOPES = [
      'https://www.googleapis.com/auth/drive.file',
      'https://www.googleapis.com/auth/drive.appfolder'
    ];

    var authorizeButton = document.getElementById('authorize_button');
    var signoutButton = document.getElementById('signout_button');
    var infoLabel = document.getElementById('infoLabel')
    var playButton = document.getElementById('playButton');
    var prevButton = document.getElementById('prevButton')
    var nextButton = document.getElementById('nextButton')
    var progress = document.getElementById('progress');
    var volumeInputer = document.getElementById('volumeInputer')
    var volumeLabel = document.getElementById('volumeLabel')
    var currentTimeLabel = document.getElementById('currentTimeLabel');
    var durationLabel = document.getElementById('durationLabel');
    var currentSongList = document.getElementById('currentSongList');
    var playlistsList = document.getElementById('playlistsList')
    var randomButton = document.getElementById('randomButton')
    var loopButton = document.getElementById('loopButton')
    var addPlayitemButton = document.getElementById('addPlayitemButton')
    var addPlaylistButton = document.getElementById('addPlaylistButton')
    var rightMenu = document.getElementById('rightMenu')

    var blockSave = false

    var gdAuthToken
    var currentGID
    var currentGIDResponse

    var audioContext = new AudioContext()
    audioContext.close()
    var source
    var volumeGain
    var isPlaying = false
    var startTime
    var config
    // playlists
    //var playitemIndex = -1
    var currentPlaylist
    var displayPlaylist
    //var displayPlaylistIndex = -1
    //var randomMode = false
    //var loopMode = 0 // 0:Loop 1:SingleLoop 2:NoLoop
    var randomIndexArray
    var displayPlayitemIndex

    var currentPlayitem
    var currentRequest
    var preloadFileId
    var preloadRequest
    var preloadResponse
    var errorFetchIndex = 0
    var errorFetchCount = 5

    randomButton.addEventListener('click', function (event) {
      setRandomMode(!config.randomMode)
    })
    loopButton.addEventListener('click', function (event) {
      setLoopMode((config.loopMode + 1) % 3)
    })

    document.getElementById('saveConfigButton').onclick = function () {
      let configName = prompt("New config name", "");
      if (configName != null && configName.length > 0) {
        createPlaylistsFile(configName)
      }
    }
    document.getElementById('loadConfigButton').onclick = function () {
      let view = new google.picker.DocsView(google.picker.ViewId.FOLDERS).
        setParent('root').
        setIncludeFolders(true).
        setSelectFolderEnabled(true).
        setMode('LIST').
        setMimeTypes('application/json')
      let picker = new google.picker.PickerBuilder().
        addView(view).
        setAppId(CLIENT_ID).
        setOAuthToken(gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token).
        setDeveloperKey(API_KEY).
        setCallback(function (data) {
          if (data.action == google.picker.Action.PICKED) {
            let file = data.docs[0]
            redirectNewURL(file.id)
          }
        }).
        build();
      picker.setVisible(true);
    }

    $(currentSongList).on('contextmenu', function () {
      return false;
    })
    $(playlistsList).on('contextmenu', function () {
      return false;
    })
    $(rightMenu).on('contextmenu', function () {
      return false;
    })
    $(document).bind("click", function () {
      rightMenu.hidden = true
    })
    progress.addEventListener('change', function (event) {
      console.log('seek to ' + progress.value);
      seek(progress.value);
    })
    volumeInputer.addEventListener('change', function (event) {
      volumeLabel.textContent = volumeInputer.value
      volumeGain.gain.value = volumeInputer.value / 100.0
    })
    var isSliding = false;
    progress.addEventListener('mousedown', function (event) {
      //console.log('seek down');
      isSliding = true;
    })
    progress.addEventListener('mouseup', function (event) {
      //console.log('seek up');
      isSliding = false;
    })

    var progressTimer = setInterval(function () {
      if (!isSliding && isPlaying) {
        let currentTime = getCurrentTime();
        progress.value = currentTime;
        currentTimeLabel.textContent = formatedTime(currentTime);
      }
    }, 500)



    /**
     *  On load, called to load the auth2 library and API client library.
     */
    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    function loadPicker() {
      gapi.load('auth', { 'callback': onAuthApiLoad });
      gapi.load('picker', { 'callback': onPickerApiLoad });
    }

    function onAuthApiLoad() {
      console.log('onAuthApiLoad')
    }

    function onPickerApiLoad() {
      console.log('onPickerApiLoad')
    }

    /**
     *  Initializes the API client library and sets up sign-in state
     *  listeners.
     */
    function initClient() {
      gapi.client.init({
        //apiKey: API_KEY,
        'client_id': CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        'scope': SCOPES.join(' '),
        'immediate': false
      }).then(function () {
        // Listen for sign-in state changes.
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        //return
        // Handle the initial sign-in state.
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        authorizeButton.onclick = handleAuthClick
        signoutButton.onclick = handleSignoutClick
        playButton.onclick = handlePlayClick
        prevButton.onclick = handlePrevClick
        nextButton.onclick = handleNextClick
        addPlayitemButton.onclick = handleAddPlayitemClick
        addPlaylistButton.onclick = handleAddPlaylistClick
      }, function (error) {
        appendPre(JSON.stringify(error, null, 2));
      });
    }

    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'block';
        //appendPre(gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().id_token);
        if (gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().id_token.length > 0) {
          //console.log("got accessToken " + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().id_token);
          //console.log("got accessToken " + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token);
          gdAuthToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().id_token
        }
        infoLabel.textContent = '已登入'

        fetchLocation()
      } else {
        authorizeButton.style.display = 'block';
        signoutButton.style.display = 'none';
        infoLabel.textContent = '←請登入 Google Drive'

        fetchLocation()
      }
    }

    function fetchLocation() {
      let urlString = location.href
      let url = new URL(urlString)
      let gid = url.searchParams.get('gid')
      if (gid != null) {
        currentGID = gid
        fetchFile(gid, function (response) {
          let json = response
          currentGIDResponse = response
          console.log('response = ' + response)
          if (typeof response !== 'undefined' && 'mimeType' in response) {
            let mimeType = json.mimeType
            if (mimeType.includes('json')) {
              loadConfig(gid)
            }
            else if (mimeType.includes('audio')) {
              config = createNewConfig(json.name, gid)
              refreshLists()
            }
            else if (mimeType.includes('google-apps.folder')) {
              loadGDFolder(json.name, gid)
            }
            else {
              console.log('unknown file type')
              infoLabel.textContent = 'Unsupported file formet.'
            }
          }
          else {
            infoLabel.textContent = 'No login, or you has no permission to access this file.'
          }
        })
      }
      else {
        console.log('gid not found')
        config = createEmptyConfig()
        refreshLists()
      }
    }

    function refreshLists() {
      $(playlistsList).empty()
      for (let i = 0; i < config.playlists.length; i++) {
        let playlist = config.playlists[i];
        let li = document.createElement("li")
        li.className = 'playitem'
        let listContent = document.createElement("BUTTON")
        listContent.style = "width: calc(100% - 24px); text-align: left; padding: 0; border: none; background-color: Transparent; outline: none;"
        listContent.textContent = playlist.name
        li.appendChild(listContent)

        $(listContent).on('mousedown', function (event) {
          let isRight = event.which == 3
          if (isRight) {
            let x = event.pageX
            let y = event.pageY
            rightMenu.hidden = false
            rightMenu.style.left = (x + 5) + 'px'
            rightMenu.style.top = (y + 5) + 'px'
            $(rightMenu).empty()
            let menuTitle = ['rename', 'delete']
            let menuCallback = [
              function () {
                let playlistName = prompt("New playlist name", "");
                if (playlistName != null && playlistName.length > 0) {
                  playlist.name = playlistName
                  refreshLists()
                }
              },
              function () {
                removePlaylist(playlist)
              }]
            for (let i = 0; i < 2; i++) {
              let menuOption = document.createElement('li')
              menuOption.style = 'list-style-type: none; padding-left: 16px'
              menuOption.appendChild(document.createTextNode(menuTitle[i]))
              rightMenu.appendChild(menuOption)
              menuOption.onmouseover = function () {
                menuOption.style.background = 'cornflowerblue'
              }
              menuOption.onmouseout = function () {
                menuOption.style.background = 'white'
              }
              menuOption.onclick = menuCallback[i]
            }
          }
        })
        if (i == config.playlistIndex) {
          li.style.backgroundColor = 'orange'
        }
        playlistsList.appendChild(li)
        listContent.onclick = function () {
          playlistListClick(i)
        }
        li.onmouseover = function () {
          if (i != config.playlistIndex) {
            li.style.backgroundColor = 'yellow'
          }
        }
        li.onmouseout = function () {
          if (i != config.playlistIndex) {
            li.style.backgroundColor = 'white'
          }
        }
      }
      if (config.playlistIndex < 0) {
        config.playlistIndex = 0
      }
      displayPlaylist = config.playlists[config.playlistIndex]
      refreshPlaylist()
    }

    function refreshPlaylist() {
      $(currentSongList).empty()
      let playlist = displayPlaylist
      for (let j = 0; j < playlist.list.length; j++) {
        let playitem = playlist.list[j]
        let li = document.createElement("li")
        li.className = 'playitem'
        if (playitem.path.includes('\\')) {
          let pathArray = playitem.path.split("\\")
          playitem.path = pathArray[pathArray.length - 1]
        }
        let listContent = document.createElement("BUTTON")
        listContent.style = "width: calc(100% - 24px); text-align: left; padding: 0; border: none; background-color: Transparent; outline: none;"
        listContent.textContent = playitem.path
        li.appendChild(listContent)

        $(listContent).on('mousedown', function (event) {
          let isRight = event.which == 3
          if (isRight) {
            let x = event.pageX
            let y = event.pageY
            rightMenu.hidden = false
            rightMenu.style.left = (x + 5) + 'px'
            rightMenu.style.top = (y + 5) + 'px'
            $(rightMenu).empty()
            let menuOption = document.createElement('li')
            menuOption.style = 'list-style-type: none; padding-left: 16px'
            menuOption.appendChild(document.createTextNode('delete'))
            rightMenu.appendChild(menuOption)
            menuOption.onmouseover = function () {
              menuOption.style.background = 'cornflowerblue'
            }
            menuOption.onmouseout = function () {
              menuOption.style.background = 'white'
            }
            menuOption.onclick = function () {
              removePlayitem(playitem)
            }
          }
        })

        currentSongList.appendChild(li);
        if (displayPlaylist === currentPlaylist && j == displayPlayitemIndex) {
          li.style.backgroundColor = 'orange'
        }
        listContent.onclick = function () {
          currentSongClick(j)
        }
        li.onmouseover = function () {
          if (j != displayPlayitemIndex) {
            li.style.backgroundColor = 'yellow'
          }
        }
        li.onmouseout = function () {
          if (j != displayPlayitemIndex) {
            li.style.backgroundColor = 'white'
          }
        }
      }
    }

    function playlistListClick(index) {
      console.log("playlist index " + index + "clicked")
      playlistsList.children[config.playlistIndex].style.backgroundColor = 'white'
      config.playlistIndex = index
      playlistsList.children[config.playlistIndex].style.backgroundColor = 'orange'
      displayPlaylist = config.playlists[index]
      refreshPlaylist()
    }

    function currentSongClick(index) {
      console.log("playitem index " + index + "clicked")
      if (config.playitemIndex < currentSongList.children.length && config.playitemIndex >= 0) {
        currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'white'
      }
      currentPlaylist = displayPlaylist
      randomIndexArray = shuffleIndexArray(currentPlaylist.list.length)
      config.playitemIndex = index
      let playitem = currentPlaylist.list[config.playitemIndex]
      displayPlayitemIndex = config.playitemIndex
      currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'orange'
      loadMusic(playitem)
    }

    function removePlayitem(playitem) {
      console.log('remove playitem, name = ' + playitem.path + ' fileId = ' + playitem.gdID)
      let index = displayPlaylist.list.indexOf(playitem)
      if (index > -1) {
        displayPlaylist.list.splice(index, 1)
        config.playlists[config.playlistIndex] = displayPlaylist
        refreshPlaylist()
        saveCurrentConfig()
      }
    }
    function removePlaylist(playlist) {
      console.log('remove playlist, name = ' + playlist.name)
      let index = config.playlists.indexOf(playlist)
      if (index > -1) {
        config.playlists.splice(index, 1)
        console.log('index = ' + index + ' displayIndex = ' + config.playlistIndex)
        if (index <= config.playlistIndex) {
          config.playlistIndex -= 1
        }
        refreshLists()
        saveCurrentConfig()
      }
    }

    function handlePlayClick(event) {
      if (audioContext.state == 'suspended') {
        console.log('audioContext suspended, try resume');
        audioContext.resume();
        playButton.textContent = 'pause';
        isPlaying = true;
      }
      else if (audioContext.state == 'running') {
        console.log('audioContext running, try pause');
        audioContext.suspend();
        playButton.textContent = 'play';
        isPlaying = false;
      }
      else if (audioContext.state == 'closed') {
        currentPlaylist = displayPlaylist
        randomIndexArray = shuffleIndexArray(currentPlaylist.list.length)
        if (currentPlaylist.length == 0) {
          console.log('current playlist no music')
          return
        }
        if (config.playitemIndex >= currentPlaylist.list.length || config.playitemIndex < 0) {
          config.playitemIndex = 0
        }
        console.log('audioContext closed, try load');
        let playitem = currentPlaylist.list[config.playitemIndex]
        console.log('displayPlayitemIndex = '+displayPlayitemIndex)
        currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'orange'
        loadMusic(playitem)
      }
    }
    function handlePrevClick(event) {
      prev()
    }
    function handleNextClick(event) {
      next(true)
    }

    function setRandomMode(mode) {
      config.randomMode = mode
      if (config.randomMode) {
        randomButton.textContent = 'Random'
      }
      else {
        randomButton.textContent = 'No Random'
        config.playitemIndex = displayPlayitemIndex
      }
    }
    function setLoopMode(mode) {
      config.loopMode = mode
      if (config.loopMode == 0) {
        loopButton.textContent = 'Loop'
      }
      else if (loopMode == 1) {
        loopButton.textContent = 'Single Loop'
      }
      else {
        loopButton.textContent = 'No Loop'
      }
    }

    function handleAddPlayitemClick(event) {
      let audioMimeType = "audio/mpeg,audio/flac,audio/mp4,audio/aac,video/mp4,application/x-flac,audio/x-flac,audio/webm,video/webm,audio/mpeg3,audio/x-mpeg-3,audio/ogg,application/ogg,audio/x-wav,audio/x-aiff,audio/basic";
      let view = new google.picker.DocsView(google.picker.ViewId.FOLDERS).
        setParent('root').
        setIncludeFolders(true).
        setSelectFolderEnabled(false).
        setMode('LIST').
        setMimeTypes(audioMimeType)
      let picker = new google.picker.PickerBuilder().
        addView(view).
        enableFeature(google.picker.Feature.MULTISELECT_ENABLED).
        setAppId(CLIENT_ID).
        setOAuthToken(gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token).
        setCallback(pickerCallback).
        build();
      picker.setVisible(true);
    }
    function pickerCallback(data) {
      if (data.action == google.picker.Action.PICKED) {
        for (let i = 0; i < data.docs.length; i++) {
          let file = data.docs[i]
          let playitem = {
            path: file.name,
            gdID: file.id
          }
          displayPlaylist.list.push(playitem)
        }
        refreshPlaylist()
        saveCurrentConfig()
      }
    }

    function handleAddPlaylistClick(event) {
      let playlistName = prompt("New playlist name", "");
      if (playlistName != null && playlistName.length > 0) {
        console.log('new playlist = ' + playlistName)
        let playlist = {
          name: playlistName,
          list: []
        }
        config.playlists.push(playlist)
        refreshLists()
        saveCurrentConfig()
      }
    }

    function seek(time) {
      source.onended = null;
      source.stop();
      setupAudioSource(source.buffer, time)
      startTime = audioContext.currentTime - time;
    }

    function prev() {
      console.log('prev')
      if (displayPlaylist === currentPlaylist) {
        currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'white'
      }
      config.playitemIndex -= 1
      if (config.playitemIndex < 0) {
        config.playitemIndex = currentPlaylist.list.length - 1
      }
      let playitem = getPlayitem(config.playitemIndex)
      if (displayPlaylist === currentPlaylist) {
        currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'orange'
      }
      loadMusic(playitem)
    }
    function next(forceNext) {
      console.log('next')
      if (displayPlaylist === currentPlaylist) {
        currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'white'
      }
      config.playitemIndex = getNextPlayitemIndex()
      if (config.playitemIndex == 0) {
        if (!forceNext && config.loopMode == 2) {
          console.log('No loop reach end')
          playButton.textContent = 'play'
          return
        }
        if (config.randomMode) {
          shuffleIndexArray(currentPlaylist.list.length)
        }
      }
      let playitem = getPlayitem(config.playitemIndex)
      if (displayPlaylist === currentPlaylist) {
        currentSongList.children[displayPlayitemIndex].style.backgroundColor = 'orange'
      }
      loadMusic(playitem)
    }

    function getCurrentTime() {
      return audioContext.currentTime - startTime;
    }
    function formatedTime(time) {
      let hours = Math.floor(time / 3600);
      let minutes = Math.floor((time - (hours * 3600)) / 60);
      let seconds = Math.floor(time - (hours * 3600) - (minutes * 60));

      if (hours == 0) {
        hours = "";
      }
      else if (hours < 10) {
        hours = "0" + hours + ":";
      }
      if (minutes < 10) { minutes = "0" + minutes; }
      if (seconds < 10) { seconds = "0" + seconds; }
      return hours + minutes + ':' + seconds;
    }

    function handSourceEnded(event) {
      console.log('source ended');
      if (config.loopMode == 1) {
        console.log('single loop, seek to 0')
        seek(0)
      }
      else {
        audioContext.close();
        isPlaying = false;
        next(false)
      }
    }
    function getNextPlayitemIndex() {
      let newIndex = config.playitemIndex + 1
      if (newIndex >= currentPlaylist.list.length) {
        newIndex = 0
      }
      return newIndex
    }
    function getPlayitem(index) {
      if (config.randomMode) {
        index = randomIndexArray[index]
      }
      displayPlayitemIndex = index
      return currentPlaylist.list[index]
    }
    function getPreloadPlayitem() {
      let index = getNextPlayitemIndex()
      if (config.randomMode) {
        index = randomIndexArray[index]
      }
      return currentPlaylist.list[index]
    }

    function handleAudioData(response) {
      let playAudio = function (buffer) {
        setupAudioSource(buffer, 0)
        startTime = audioContext.currentTime;
        isPlaying = true;
        errorFetchIndex = 0
        progress.max = buffer.duration;
        durationLabel.textContent = formatedTime(buffer.duration);
        console.log('playAudio load succeseed');
        infoLabel.textContent = 'Playing ' + currentPlayitem.path
        playButton.textContent = 'pause';
        startPreload()
      }
      let handleError = function (error) {
        audioContext.close();
        isPlaying = false;
        console.log('playAudio load failed');
        playButton.textContent = 'load';

        if (response.byteLength == 0) {
          infoLabel.textContent = "沒有檔案訪問權限，請確認 Google Drive 身份"
        }
        else {
          errorFetchIndex += 1
          if (errorFetchIndex < errorFetchCount) {
            next(false)
          }
        }
      }
      audioContext.decodeAudioData(response, playAudio, handleError);
    }

    function setupAudioSource(buffer, startTime) {
      let newSource = audioContext.createBufferSource()
      newSource.buffer = buffer;
      let gain = audioContext.createGain()
      gain.gain.value = volumeInputer.value / 100.0
      newSource.connect(gain)
      gain.connect(audioContext.destination)
      newSource.start(0, startTime);
      newSource.onended = handSourceEnded
      source = newSource
      volumeGain = gain
    }

    function loadMusic(playitem) {
      isPlaying = false;
      if (audioContext.state != 'closed') {
        audioContext.close();
      }
      infoLabel.textContent = 'Loading ' + playitem.path + ' ...'
      currentPlayitem = playitem
      audioContext = new AudioContext();
      if (preloadResponse != null && preloadFileId == playitem.gdID) {
        console.log('preload found')
        handleAudioData(preloadResponse)
        preloadResponse = null
        preloadFileId = null
        return
      }
      console.log('preload not found, start fetch')
      if (preloadRequest != null) {
        preloadRequest.abort()
        preloadRequest = null
      }
      if (currentRequest != null) {
        console.log('last current request not finish, abort it')
        currentRequest.abort()
      }
      preloadRequest = null
      preloadResponse = null
      preloadFileId = null

      currentRequest = new XMLHttpRequest();
      let accessToken = gapi.auth.getToken().access_token;
      currentRequest.open('GET', 'https://www.googleapis.com/drive/v3/files/' + currentPlayitem.gdID + '?alt=media');
      currentRequest.setRequestHeader('Authorization', 'Bearer ' + accessToken);
      currentRequest.responseType = 'arraybuffer';
      currentRequest.onload = function () {
        console.log("request onload");
        handleAudioData(currentRequest.response)
        currentRequest = null
      };
      currentRequest.onerror = function () {
        console.log("request onerror");
        currentRequest = null
        isPlaying = false;
        errorFetchIndex += 1
        if (errorFetchIndex < errorFetchCount) {
          next(false)
        }
      };
      currentRequest.send();
    }

    function startPreload() {
      let nextPlayitem = getPreloadPlayitem()
      preloadMusic(nextPlayitem)
    }

    function preloadMusic(playitem) {
      console.log('preload ' + playitem.gdID)
      let accessToken = gapi.auth.getToken().access_token;
      preloadFileId = playitem.gdID
      preloadRequest = new XMLHttpRequest();
      preloadRequest.open('GET', 'https://www.googleapis.com/drive/v3/files/' + playitem.gdID + '?alt=media');
      preloadRequest.setRequestHeader('Authorization', 'Bearer ' + accessToken);
      preloadRequest.responseType = 'arraybuffer';
      preloadRequest.onload = function () {
        console.log("preload onload");
        preloadResponse = preloadRequest.response
        preloadRequest = null
        saveCurrentConfig()
      };
      preloadRequest.onerror = function () {
        console.log("preload onerror");
        preloadRequest = null
      };
      preloadRequest.send();
    }

    function loadConfig(fileId) {
      console.log('start loadConfig')
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://www.googleapis.com/drive/v3/files/' + fileId + '?alt=media');
      //xhr.responseType = 'json';
      var accessToken = gapi.auth.getToken().access_token;
      xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
      xhr.onload = function () {
        var status = xhr.status;
        if (status === 200) {
          let json = JSON.parse(xhr.response)
          config = json
          if (config.playitemIndex < 0) {
            config.playitemIndex = 0
          }
          displayPlayitemIndex = config.playitemIndex
          volumeInputer.value = config.volume * 100
          volumeLabel.textContent = volumeInputer.value
          setRandomMode(config.randomMode)
          setLoopMode(config.loopMode)
          refreshLists()
        }
        else {

        }
      };
      xhr.onerror = function () {

      };
      xhr.send();
    }

    function saveCurrentConfig() {
      config.volume = volumeInputer.value / 100.0
      if (config.randomMode) {
        let newConfig = JSON.parse(JSON.stringify(config))
        newConfig.playitemIndex = displayPlayitemIndex
        saveConfig(newConfig)
      }
      else {
        saveConfig(config)
      }
    }

    function saveConfig(data) {
      if (currentGIDResponse == null || !currentGIDResponse.mimeType.includes('json')) { return }
      if (blockSave) { return }
      let contentType = 'application/json'
      let metadata = {
        name: currentGIDResponse.name,
        mimeType: contentType
      }
      let fileData = JSON.stringify(data)

      let boundary = 'GDUploadLine'
      let delimiter = "\r\n--" + boundary + "\r\n";
      let close_delim = "\r\n--" + boundary + "--";

      let multipartRequestBody =
        delimiter +
        'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
        JSON.stringify(metadata) +
        delimiter +
        'Content-Type: ' + contentType + '\r\n\r\n' +
        fileData + '\r\n' +
        close_delim;

      let xhr = new XMLHttpRequest();
      let url = 'https://www.googleapis.com/upload/drive/v3/files/' + currentGID + '?uploadType=multipart'
      xhr.open('PATCH', url)
      let accessToken = gapi.auth.getToken().access_token;
      xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken)
      xhr.setRequestHeader('Content-Type', 'multipart/related; boundary=' + boundary)
      xhr.responseType = 'json'
      xhr.onload = function () {
        console.log('saveConfig onload, response = ' + JSON.stringify(xhr.response))
      };
      xhr.onerror = function () {
        console.log('saveConfig onerror, error = ' + xhr.error)
        alert('save playlists failure, undo previous edit.')
        loadConfig(currentGID)
      };
      xhr.send(multipartRequestBody);
    }

    function createPlaylistsFile(fileName) {
      let contentType = 'application/json'
      let metadata = {
        name: fileName,
        mimeType: contentType
      }
      let fileData = JSON.stringify(config)

      let boundary = 'GDUploadLine'
      let delimiter = "\r\n--" + boundary + "\r\n";
      let close_delim = "\r\n--" + boundary + "--";

      let multipartRequestBody =
        delimiter +
        'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
        JSON.stringify(metadata) +
        delimiter +
        'Content-Type: ' + contentType + '\r\n\r\n' +
        fileData + '\r\n' +
        close_delim;

      let xhr = new XMLHttpRequest();
      let url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart'
      xhr.open('POST', url)
      let accessToken = gapi.auth.getToken().access_token;
      xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken)
      xhr.setRequestHeader('Content-Type', 'multipart/related; boundary=' + boundary)
      xhr.responseType = 'json'
      xhr.onload = function () {
        redirectNewURL(xhr.response.id)
      };
      xhr.onerror = function () {
        console.log('saveConfig onerror, error = ' + xhr.error)
        alert('Save as file in drive failure')
      };
      xhr.send(multipartRequestBody);
    }

    function getURL(url, callback) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.responseType = 'json';
      xhr.onload = function () {
        var status = xhr.status;
        if (status === 200) {
          callback(xhr.response, null);
        }
        else {
          callback(xhr.response, new Error('http error'));
        }
      };
      xhr.onerror = function () {
        callback(null, new Error('request failed'));
      };
      xhr.send();
    }

    function redirectNewURL(gid) {
      let url = new URL(location.href)
      let urlPara = new URLSearchParams('gid=' + gid)
      url.search = urlPara
      console.log('redirect to ' + url.href)
      window.location.href = url.href
    }

    function shuffleIndexArray(length) {
      let array = new Array(length)
      for (let i = 0; i < length; i++) {
        array[i] = i
      }
      for (let i = array.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array
    }

    function createEmptyConfig() {
      let config = {
        volume: 1,
        loopMode: 0,
        randomMode: true,
        playitemIndex: -1,
        playlistIndex: 0,
        playlists: [
          {
            name: 'unnamed playlist',
            list: []
          }
        ]
      }
      console.log('empty config = ' + JSON.stringify(config))
      return config
    }
    function createNewConfig(path, fileId) {
      let config = {
        volume: 1,
        loopMode: 0,
        randomMode: true,
        playitemIndex: -1,
        playlistIndex: 0,
        playlists: [
          {
            name: 'unnamed playlist',
            list: [
              {
                path: path,
                gdID: fileId
              }
            ]
          }
        ]
      }
      console.log('empty config = ' + JSON.stringify(config))
      return config
    }
    function loadGDFolder(playlistName, gid) {
      gapi.client.drive.files.list({
        'q': "'" + gid + "' in parents"
      }).then(function (response) {
        config = createEmptyConfig()
        let playlists = [{
          name: playlistName,
          list: []
        }]
        for (let i = 0; i < response.result.files.length; i++) {
          let file = response.result.files[i]
          if (file.mimeType.includes('audio')) {
            let playitem = {
              path: response.result.files[i].name,
              gdID: response.result.files[i].id
            }
            playlists[0].list.push(playitem)
          }
        }
        config.playlists = playlists
        refreshLists()
      });
    }


    /**
     * Download a file's content.
     *
     * @param {File} file Drive File instance.
     * @param {Function} callback Function to call when the request is complete.
     */
    function fetchFile(fileId, callback) {
      let request = gapi.client.drive.files.get({
        'fileId': fileId
      })
      request.execute(function (response) {
        callback(response.result)
      })
    }

    function saveFile(blob) {
      var fileName = 'Test.m4a'
      var tempEl = document.createElement("a");
      document.body.appendChild(tempEl);
      tempEl.style = "display: none";
      url = window.URL.createObjectURL(blob);
      tempEl.href = url;
      tempEl.download = fileName;
      tempEl.click();
      window.URL.revokeObjectURL(url);
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick(event) {
      gapi.auth2.getAuthInstance().signIn();
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick(event) {
      gapi.auth2.getAuthInstance().signOut();
    }

    /**
     * Append a pre element to the body containing the given message
     * as its text node. Used to display the results of the API call.
     *
     * @param {string} message Text to be placed in pre element.
     */
    function appendPre(message) {
      var pre = document.getElementById('content');
      var textContent = document.createTextNode(message + '\n');
      pre.appendChild(textContent);
    }

    /**
     * Print files.
     */
    function listFiles() {
      gapi.client.drive.files.list({
        'pageSize': 10,
        'fields': "nextPageToken, files(id, name)"
      }).then(function (response) {
        appendPre('Files:');
        var files = response.result.files;
        if (files && files.length > 0) {
          for (var i = 0; i < files.length; i++) {
            var file = files[i];
            appendPre(file.name + ' (' + file.id + ')');
          }
        } else {
          appendPre('No files found.');
        }
      });
    }

  </script>

  <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
    onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  <script type="text/javascript" src="https://apis.google.com/js/api.js?onload=loadPicker"></script>
</body>

</html>